<form [formGroup]="form" class="space-y-6 p-4">
  <!-- Paso 0: ¬øTiene cotizaci√≥n guardada? -->
  <div class="step-card">
    <h3 class="step-title">¬øYa tiene una cotizaci√≥n guardada?</h3>
    <p class="step-help">Si ya tiene una cotizaci√≥n en Internet o en su computadora, puede cargarla aqu√≠</p>
    <div class="load-buttons">
      <button type="button" (click)="cargarCotizacion()" class="load-btn load-btn-cloud">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
        </svg>
        <div>
          <div class="load-btn-title">Abrir de Internet</div>
          <div class="load-btn-desc">Ver mis cotizaciones guardadas en la nube</div>
        </div>
      </button>
      <button type="button" (click)="importar_cotizacion()" class="load-btn load-btn-pc">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <div>
          <div class="load-btn-title">Abrir de Mi PC</div>
          <div class="load-btn-desc">Cargar archivo guardado en mi computadora</div>
        </div>
      </button>
    </div>
  </div>

  <!-- Header Principal -->
  <div class="header-section">
    <h1 class="main-title">üìã Nueva Cotizaci√≥n</h1>
    <p class="subtitle">Complete los siguientes datos para crear su cotizaci√≥n</p>
  </div>

  <!-- Moneda y N√∫mero de Cotizaci√≥n -->
  <div class="form-control">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="moneda" class="label font-medium">Moneda</label>
        <select
          formControlName="moneda"
          id="moneda"
          class="select select-bordered w-full"
        >
          <option value="CLP">CLP</option>
          <option value="UF">UF</option>
        </select>
      </div>
      <div>
        <label for="nro_cotizacion" class="label font-medium">N¬∫ Cotizaci√≥n</label>
        <input formControlName="nro_cotizacion" id="nro_cotizacion" placeholder="N¬∞ Cotizaci√≥n" class="input input-bordered w-full"/>
      </div>
    </div>
  </div>

  <!-- Empresa -->
  <div class="collapse collapse-arrow bg-base-200 rounded-lg shadow">
    <input type="checkbox" />
    <div class="collapse-title text-lg font-bold">DATOS DE SU EMPRESA</div>
    <div class="collapse-content space-y-3">
      <div class="form-control">
        <label for="nombre_empresa" class="label">Nombre Empresa</label>
        <input
          formControlName="nombre_empresa"
          id="nombre_empresa"
          placeholder="Nombre Empresa"
          class="input input-bordered w-full"
        />
      </div>
      <div class="form-control">
        <label for="logo" class="label">Su Logo</label>
        <input
          type="file"
          formControlName="logo"
          id="logo"
          class="file-input file-input-bordered w-full"
        />
      </div>
      <div class="form-control">
        <label for="rut_empresa" class="label">RUT Empresa</label>
        <input
          formControlName="rut_empresa"
          id="rut_empresa"
          placeholder="RUT Empresa"
          class="input input-bordered w-full"
        />
      </div>
      <div class="form-control">
        <label for="telefono_empresa" class="label">Tel√©fono Empresa</label>
        <input
          formControlName="telefono_empresa"
          id="telefono_empresa"
          placeholder="Tel√©fono Empresa"
          class="input input-bordered w-full"
        />
      </div>
      <div class="form-control">
        <label for="email_empresa" class="label">Email Empresa</label>
        <input
          formControlName="email_empresa"
          id="email_empresa"
          placeholder="Email Empresa"
          class="input input-bordered w-full"
        />
      </div>
      <div class="form-control">
        <label for="direccion_empresa" class="label">Direcci√≥n Empresa</label>
        <input
          formControlName="direccion_empresa"
          id="direccion_empresa"
          placeholder="Direcci√≥n Empresa"
          class="input input-bordered w-full"
        />
      </div>
    </div>
  </div>

  <!-- Cliente -->
  <div class="collapse collapse-arrow bg-base-200 rounded-lg shadow">
    <input type="checkbox" />
    <div class="collapse-title text-lg font-bold">DATOS DEL CLIENTE</div>
    <div class="collapse-content space-y-3">
      <div class="form-control">
        <label for="nombre_cliente" class="label">Nombre Cliente</label>
        <input
          formControlName="nombre_cliente"
          id="nombre_cliente"
          placeholder="Nombre Cliente"
          class="input input-bordered w-full"
        />
      </div>
      <div class="form-control">
        <label for="obra_cliente" class="label">Obra/Trabajo</label>
        <input
          formControlName="obra_cliente"
          id="obra_cliente"
          placeholder="Obra Cliente"
          class="input input-bordered w-full"
        />
      </div>
      <div class="form-control">
        <label for="contacto_cliente" class="label">Contacto Cliente</label>
        <input
          formControlName="contacto_cliente"
          id="contacto_cliente"
          placeholder="Contacto Cliente"
          class="input input-bordered w-full"
        />
      </div>
      <div class="form-control">
        <label for="email_cliente" class="label">Email Cliente</label>
        <input
          formControlName="email_cliente"
          id="email_cliente"
          placeholder="Email Cliente"
          class="input input-bordered w-full"
        />
      </div>
      <div class="form-control">
        <label for="direccion_cliente" class="label">Direcci√≥n Cliente</label>
        <input
          formControlName="direccion_cliente"
          id="direccion_cliente"
          placeholder="Direcci√≥n Cliente"
          class="input input-bordered w-full"
        />
      </div>
      <div class="form-control">
        <label for="fecha" class="label">Fecha</label>
        <input
          type="date"
          formControlName="fecha"
          id="fecha"
          class="input input-bordered w-full"
        />
      </div>
    </div>
  </div>

  <!-- Productos -->
  <div class="bg-base-200 p-4 rounded-lg shadow space-y-3">
    <h2 class="text-lg font-bold">PRODUCTOS / SERVICIOS</h2>
    <p class="helper-text">üì¶ Agregue los productos o servicios que desea cotizar</p>
    <div class="flex flex-col gap-2">
      <button
        type="button"
        (click)="addProduct()"
        class="btn-add-product-new"
      >
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <span>Agregar Producto / Servicio</span>
      </button>
      <span class="product-counter">Total: {{productosArray.length}} producto(s)</span>
      
      <!-- Vista Desktop: Tabla normal -->
      <div class="overflow-x-auto desktop-table">
        <table class="table table-zebra w-full text-sm">
          <thead>
            <tr>
              <th>Producto/Servicio</th>
              <th>Descripci√≥n</th>
              <th>Unidad</th>
              <th>Cantidad</th>
              <th>Valor Unitario</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody formArrayName="productos">
            @for (control of productosArray.controls; track control; let index=$index){
              <tr [formGroupName]="index">
                <td>
                  <textarea
                    formControlName="producto"
                    class="textarea textarea-bordered textarea-sm w-full"
                  ></textarea>
                </td>
                <td>
                  <textarea
                    formControlName="descripcion"
                    class="textarea textarea-bordered textarea-sm w-full"
                  ></textarea>
                </td>
                <td>
                  <select
                    formControlName="unidad"
                    class="select select-bordered select-sm w-full"
                  >
                    <option value="" disabled>Seleccione</option>
                    <option value="na">N/A</option>
                    <option value="m">m</option>
                    <option value="m2">m¬≤</option>
                    <option value="m3">m¬≥</option>
                    <option value="cm">cm</option>
                    <option value="cm2">cm¬≤</option>
                  </select>
                </td>
                <td>
                  <input
                    formControlName="cantidad"
                    type="number"
                    min="0"
                    class="input input-bordered input-sm w-full"
                  />
                </td>
                <td>
                  <input
                    formControlName="valorUnitario"
                    type="number"
                    min="0"
                    class="input input-bordered input-sm w-full"
                  />
                </td>
                <td>
                  {{ getTotal(index) | number:'1.0-0' }}
                </td>
                <td>
                  <button
                    type="button"
                    (click)="removeProduct(index)"
                    class="btn btn-error btn-xs"
                  >
                    Eliminar
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Vista Mobile: Cards -->
      <div class="mobile-products" formArrayName="productos">
        @for (control of productosArray.controls; track control; let index=$index){
          <div class="product-card-mobile" [formGroupName]="index">
            <div class="mobile-card-header">
              <span class="product-number">Producto #{{index + 1}}</span>
              <button type="button" (click)="removeProduct(index)" class="btn btn-error btn-xs">Eliminar</button>
            </div>
            
            <div class="mobile-card-content">
              <div class="form-control">
                <label class="label-mobile">Producto/Servicio</label>
                <textarea formControlName="producto" class="textarea textarea-bordered textarea-sm w-full"></textarea>
              </div>

              <div class="form-control">
                <label class="label-mobile">Descripci√≥n</label>
                <textarea formControlName="descripcion" class="textarea textarea-bordered textarea-sm w-full"></textarea>
              </div>

              <div class="form-control">
                <label class="label-mobile">Unidad</label>
                <select formControlName="unidad" class="select select-bordered select-sm w-full">
                  <option value="" disabled>Seleccione</option>
                  <option value="na">N/A</option>
                  <option value="m">m</option>
                  <option value="m2">m¬≤</option>
                  <option value="m3">m¬≥</option>
                  <option value="cm">cm</option>
                  <option value="cm2">cm¬≤</option>
                </select>
              </div>

              <div class="mobile-grid-2">
                <div class="form-control">
                  <label class="label-mobile">Cantidad</label>
                  <input formControlName="cantidad" type="number" min="0" class="input input-bordered input-sm w-full"/>
                </div>

                <div class="form-control">
                  <label class="label-mobile">Valor Unitario</label>
                  <input formControlName="valorUnitario" type="number" min="0" class="input input-bordered input-sm w-full"/>
                </div>
              </div>

              <div class="mobile-total">
                <span class="mobile-total-label">Total:</span>
                <span class="mobile-total-value">$ {{ getTotal(index) | number:'1.0-0':'es' }}</span>
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Resumen -->
    <h2 class="text-lg font-bold">RESUMEN</h2>
    <div class="overflow-x-auto">
      <table class="table table-compact w-full">
        <thead>
          <tr>
            <th>Subtotal</th>
            <th>IVA (19%)</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>$ {{ getSubtotal() | number:'1.0-0':'es' }}</td>
            <td>$ {{ getIVA() | number:'1.0-0':'es' }}</td>
            <td>$ {{ getTotalCotizacion() | number:'1.0-0':'es' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Condiciones -->
  <div class="bg-base-200 p-4 rounded-lg shadow space-y-3">
    <h2 class="text-lg font-bold">CONDICIONES DE LA COTIZACI√ìN</h2>
    <p class="helper-text">üìù Indique las condiciones comerciales de su cotizaci√≥n</p>
    <div class="form-control">
      <label for="validez_oferta" class="label">Validez Oferta</label>
      <input
        formControlName="validez_oferta"
        id="validez_oferta"
        placeholder="Validez Oferta"
        class="input input-bordered w-full"
      />
    </div>
    <div class="form-control">
      <label for="forma_pago" class="label">Forma de Pago</label>
      <input
        formControlName="forma_pago"
        id="forma_pago"
        placeholder="Forma de Pago"
        class="input input-bordered w-full"
      />
    </div>
    <div class="form-control">
      <label for="presupuesto_incluye" class="label">Presupuesto Incluye</label>
      <input
        formControlName="presupuesto_incluye"
        id="presupuesto_incluye"
        placeholder="Presupuesto Incluye"
        class="input input-bordered w-full"
      />
    </div>
  </div>

  <!-- Acciones Finales -->
  <div class="final-section">
    <h2 class="final-title">¬øQu√© quiere hacer ahora?</h2>
    <p class="final-subtitle">Elija la acci√≥n que necesite realizar con su cotizaci√≥n</p>

    <div class="action-buttons-grid">
      <!-- Crear Documento -->
      <button type="button" (click)="generar_doc()" class="action-btn action-btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <div class="btn-content">
          <div class="btn-title">üìÑ Crear Documento Word</div>
          <div class="btn-desc">Genera un archivo .docx listo para imprimir o enviar</div>
        </div>
      </button>

      <!-- Guardar en Internet -->
      <button type="button" (click)="guardarCotizacion()" class="action-btn action-btn-success">
        <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
        </svg>
        <div class="btn-content">
          <div class="btn-title">üíæ Guardar en Internet</div>
          <div class="btn-desc">Guarda en la nube para acceder desde cualquier lugar</div>
        </div>
      </button>

      <!-- Guardar en PC -->
      <button type="button" (click)="exportar_cotizacion()" class="action-btn action-btn-warning">
        <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
        </svg>
        <div class="btn-content">
          <div class="btn-title">üíª Guardar en Mi PC</div>
          <div class="btn-desc">Descarga un archivo a su computadora (funciona sin Internet)</div>
        </div>
      </button>

      <!-- Limpiar Formulario -->
      <button type="button" (click)="limpiarFormulario()" class="action-btn action-btn-danger">
        <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        <div class="btn-content">
          <div class="btn-title">üóëÔ∏è Empezar de Nuevo</div>
          <div class="btn-desc">‚ö†Ô∏è Esto borra TODOS los datos del formulario actual</div>
        </div>
      </button>
    </div>
  </div>
</form>
